FROM nginx:latest

COPY /server/nginx/nginx.conf.template /etc/nginx/conf.d/default.conf.template

# 필요한 ARG 정의
ARG REACT_SERVER_ENV_STATUS
ARG REACT_SERVER01_EC2_HOST
ARG NGINX_SERVER01_EC_HOST
ARG REACT_SERVER01_EC2_PROTOCOL
ARG REACT_SERVER01_EC2_PORT
ARG EXPRESS_SERVER01_EC2_PROTOCOL
ARG EXPRESS_SERVER01_EC2_HOST
ARG EXPRESS_SERVER01_EC2_PORT
ARG SIGNAL_SERVER01_PROTOCOL
ARG SIGNAL_SERVER01_EC2_HOST
ARG SIGNAL_SERVER01_PORT
ARG SIGNAL_SERVER01_SOCKET_PROTOCOL

# ARG를 ENV로 설정
ENV REACT_SERVER01_EC2_HOST=${REACT_SERVER01_EC2_HOST}
ENV REACT_SERVER01_EC2_PROTOCOL=${REACT_SERVER01_EC2_PROTOCOL}
ENV REACT_SERVER01_EC2_PORT=${REACT_SERVER01_EC2_PORT}

ENV EXPRESS_SERVER01_EC2_HOST=${EXPRESS_SERVER01_EC2_HOST}
ENV EXPRESS_SERVER01_EC2_PROTOCOL=${EXPRESS_SERVER01_EC2_PROTOCOL}
ENV EXPRESS_SERVER01_EC2_PORT=${EXPRESS_SERVER01_EC2_PORT}

ENV SIGNAL_SERVER01_EC2_HOST=${SIGNAL_SERVER01_EC2_HOST}
ENV SIGNAL_SERVER01_PROTOCOL=${SIGNAL_SERVER01_PROTOCOL}
ENV SIGNAL_SERVER01_SOCKET_PROTOCOL=${SIGNAL_SERVER01_SOCKET_PROTOCOL}
ENV SIGNAL_SERVER01_PORT=${SIGNAL_SERVER01_PORT}

# Nginx 설정 파일 생성
RUN envsubst '$$REACT_SERVER01_EC2_HOST \
    $$REACT_SERVER01_EC2_PROTOCOL \
    $$REACT_SERVER01_EC2_PORT \
    $$EXPRESS_SERVER01_EC2_HOST \
    $$EXPRESS_SERVER01_EC2_PROTOCOL \
    $$EXPRESS_SERVER01_EC2_PORT \
    $$SIGNAL_SERVER01_EC2_HOST \
    $$SIGNAL_SERVER01_PROTOCOL \
    $$SIGNAL_SERVER01_SOCKET_PROTOCOL \
    $$SIGNAL_SERVER01_PORT' < /etc/nginx/conf.d/default.conf.template > /etc/nginx/conf.d/default.conf

RUN cat /etc/nginx/conf.d/default.conf 

EXPOSE 80